<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ozstrategy.dao.userrole.UserDao">
    <!--<cache type="org.mybatis.caches.ehcache.EhcacheCache"/>-->
    <resultMap id="userResult" type="com.ozstrategy.model.userrole.User" autoMapping="true">
        <id property="id" column="id"/>
        <association property="project" column="projectId" select="com.ozstrategy.dao.project.ProjectDao.getProjectById"/>
        <collection property="roles" column="id" select="com.ozstrategy.dao.userrole.RoleDao.getRoleByUserId" fetchType="lazy"/>
    </resultMap>
    
    <select id="listUsers" resultMap="userResult" parameterType="Map">
        select u.* from ext_user u where u.projectId=#{projectId}
        <if test="keyword!=null and keyword!=''">and (u.username like CONCAT(CONCAT('%', #{keyword}), '%') or u.nickName like CONCAT(CONCAT('%', #{keyword}), '%'))</if>
        order by u.createDate desc
    </select>
    <select id="listUsersCount" resultType="java.lang.Integer" parameterType="Map">
        select count(id) from ext_user u where u.projectId=#{projectId}
        <if test="keyword!=null and keyword!=''">and (u.username like CONCAT(CONCAT('%', #{keyword}), '%') or u.nickName like CONCAT(CONCAT('%', #{keyword}), '%'))</if>
    </select>
    
    <select id="getUserById" parameterType="long" resultMap="userResult">
        select u.* from ext_user u where u.id=#{id} 
    </select>
    <select id="getUserByUsername" parameterType="Map" resultMap="userResult">
        <choose>
            <when test="projectId==null">
                select u.* from ext_user u where u.username=#{username} and projectId is null
            </when>
            <otherwise>
                select u.* from ext_user u where u.username=#{username} and u.projectId=#{projectId}
            </otherwise>
        </choose>
    </select>
    
    <select id="getUserCountByProjectId" parameterType="long" resultType="int">
        SELECT COUNT(id) from ext_user u where u.projectId=#{projectId}
    </select>
    <select id="getUserByRoleId" parameterType="long" resultMap="userResult">
          select * from ext_user u JOIN ext_userrole ur on u.id=ur.userId where ur.roleId=#{roleId}
    </select>
</mapper>